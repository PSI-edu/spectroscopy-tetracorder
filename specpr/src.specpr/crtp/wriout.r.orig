subroutine wriout
implicit integer*4(i-n)
#ccc  version date: 06/01/83
#ccc  author(s): roger clark & jeff hoover
#ccc  language:  fortran
#ccc
#ccc  short description:
#ccc            this subroutine plots the data on the crt display.
#ccc  algorithm description: none
#ccc  system requirements:   none
#ccc  subroutines called:
#ccc            scaling,crtpsc,movabs,sb,wavlng,alplty,chplta
#ccc            iwplta,crtplt,sb,movabs,unglic,what,crtin,wjfren
#ccc            dltpts,redhed,lprpct,setspool,chginf,er,pdata,
#ccc            dumpspool
#ccc  argument list description:
#ccc     argumrnts: none
#ccc  parameter description:
#ccc  common description:
#ccc  message files referenced:
#ccc  internal variables:
#ccc  file description:
#ccc  user command lines:
#ccc  update information:
#ccc  notes:
#ccc

include "../common/blank"
include "../common/lbl7"
include "../common/lbl6"
include "../common/lbl4"
include "../common/label1"
include "../common/labl2"
include "../common/lbl3"
include "../common/label3"
include "../common/labelf"
include "../common/lblg"
include "../common/hptrm"
include "../common/lundefs"
include "../common/alphabet"
include "../common/dscrch"

dimension idlt(4864)
equivalence (idlt(1),datsc3(1))
real lbnd
character*8 aname
character*80 outline        # for X-window writes
#RED
integer*4 iwidok    # function


#
#
#     this subroutine plots the data on the crt display
#
#
#     plot times: on TI980B: (for 120 channels)
#                no errors points not connected   7.2 sec.
#                no errors connect points         8.0 sec.
#                errors points not connected    11.0  sec.
#                errors points connected        12.5  sec.
#          times the same for channel, wavelength, energy space
#
#
9999    ji = 80
i = 0
ibncn2 = 0
ixit = 0
#
#  find line type
#
if (idad!=2)
    do i = 1,nchans
        error(i) = 0.0
if (ictrl!=ihi) {
    if (ictrl!=iho)
        call er
    if (iauto!=ihb) {
        if (iauto!=iha) {
            igo = 8
            go to 10
        }
    }
#
#     call scaling (horizontal and vertical) routine.
#
    igo = 9
    go to 10
}
repeat {
    inxt = 0
    call chinfo(inxt)
    if (inxt==ihx) go to 30
    if (inxt==ihe) return
    if (inxt==ihg) go to 9999
    if (inxt!=ihr) {
        repeat {     #     calculate parameters for the plot
            lbnd = bbnd
            diff = ubnd-lbnd
            if (diff>0.1e-15) go to 20
            repeat {
               igo = 6
10             call crtpsc(igo,bbnd,ubnd,nchans,datac,error,wmina,wmaxa,i,dataa)
               if (igo!=4) break 1
20             ig = 1
               repeat {
                    if (ji>=80) {
                        if (ictrl!=iho) call er
                        if (ig==0) ig = 1
                        repeat {
                            call wavlng (itrol(1), itrol(2), ier)
                            if (igrmod >= 99)
                                call lpcrtp(1,nchans,lbnd,ubnd,dataa)
                            if (igrmod < 99) {
#
#     write  identification to the plot
#
                                call movabs(0,295)
                                call sb(0)
                                call namdev (idv1,aname)
                                write(outline,40)ititl,idv1,ifl1,aname
                                call gwrite(outline)
                                write(outline,41)ihist
                                call gwrite(outline)

#
#     draw the plot
#
                                call alplty(lbnd,ubnd)
                                diff = ubnd-lbnd
                                if (itrol(3)==iha)
                                    call wvplta(nchans,wvmax,wvmin,iline)
                                if (itrol(3)==ihn)
                                    call iwplta(nchans,wvmax,wvmin,iline)
                                xmax = wvmax
                                xmin = wvmin
                                if (itrol(3)!=iha&&itrol(3)!=ihn)
                                    call chplta(nchans,xmax,xmin,dataa,iline)
                                call crtplt(nchans,xmax,xmin,lbnd,diff,datac,dataa,iline)
                                call movabs(0,360)
                                call sb(0)
                            }
                            if (ictrl==iho) 
                                go to 920
                            if (iauto==ihb)
                                call lprpct(1,nchans,lbnd,ubnd,dataa)
                            if (iauto==ihb)
                                return
#
#     call glich removal routine
#
                            if (ig==ihg)
                                call unglic(ig)
                            if (ig==ihg)
                                go to 910
                            if (ig==0)
                                go to 910

                            if ( igrmod <99 ) {
#
#     write wavelength info
#
                                call movabs(0,3)
                                call sb(0)
                                if (igrmod == 50 || igrmod == 51) {
                                    write(outline,43)itrol(1),itrol(2),nchans
                                } else {
                                    write(outline,42)itrol(1),itrol(2),nchans
                                }
                                call gwrite(outline)
                            }
                            call movabs(0,360)
                            call sb(0)
# write user menu
                            write(outline,60)
                            call gwrite(outline)
                            write(outline,61)
                            call gwrite(outline)
                            write(outline,62)
                            call gwrite(outline)
                            write(outline,63)
                            call gwrite(outline)
                            write(outline,64)
                            call gwrite(outline)
#
                            j = 1
                            while (j < 80 || igrmod < 99) {
                                if (j>=80) call what(j)
                                call crtin
                                j = 1
                                call wjfren(j,x,i)
                                if (j<80)
                                    go to 900
                            }
                        }
900                     continue
#
#     store iopcon in mhistb
#
                        mhistb(1:80) = iopcon
                        il = 0
                        j = 1
                        ji = 1
                    }
#
#     restore iopcon
#
                    iopcon = mhistb(1:80)
                    j = ji
                    call wjfren(j,x,i)
                    ji = j
                    call wjfren(j,x,il)
                    if (iwidok(i) == 1) {     # C,V,W,D, U, or Y: wavelengths
                        if (x>0 & x< maxrec) {
                            itrol(1) = i
                            itrol(2) = x
                        } else {
                            write (outline,45) itrol(1),itrol(2)
                            call gwrite(outline)
                        }
                    }
                    if (i==ihb) {
                        ibncn2 = ihb
                        return
                    }
                    if (i==ihh || i == iha || i == ihn) itrol(3) = i
                    if (i!=iha&&i!=ihn) {
                        if (i!=ihh) {
                            if (i==ihg) {
                                ig = ihg
                                next 1
                            }
                            if (i==ihc) go to 930
                            if (i==ihcg ) {   # graphics cursor position
                                call serase(0,310,511,368)
                                call movabs (0,359)
                                call sb(0)
                                write (outline,72)
                                call gwrite(outline)
                                if (igrmod == 50 || igrmod == 51) {
                                    write (outline,74)
                                } else {
                                    write (outline,73)
                                }
			        call gwrite(outline)
				iier = 0
				while(iier != ihe && iier != ihx && iier != -1) {
					call gcrpos(iix,iiy,txpos,typos,
						xmax,xmin,lbnd,diff,iopcon,iier)
					call gcchan(iix,iiy,txpos,typos,
						imatch,nchans,dataa,datac,iier)
				}
                                next 1
                            }
                            if (i==ihcs) {
				bbnd = lbnd
                                call window(bbnd,ubnd,xmin,xmax,diff)
                                wmina=xmin
                                wmaxa=xmax
				lbnd = bbnd
                            }
                            if (i==ihca) {    # band analysis
                                call bdanal(lbnd,diff,xmax,xmin)
                            }
                            if (i==ihe) {
                                call movabs(0,360)
                                call sb(0)
                                return
                            }
                            lbnd = bbnd
                            if (i==ihi) go to 940
                            if (i==ihl) {
                                iline = x
                                if (x<0||x>10) iline = 0
                                next 1
                            } else if (i==ihr) {
                                call dltpts(ji,ijk,idlt,4864,ic)
                                if (ijk==0&&ic==ihc) ji = 80
                                if (ijk>0) {
                                    do kk = 1,ijk {
                                        datac(idlt(kk)) = -1.23e34
                                        data(idlt(kk)) = -1.23e34
                                    }
                                }
                                next 1
                            } else if (i==ihp && il==ihd) {
                                lpline = 60
                                call setspo
                                call pdata(0,1,1,1,filno,lpline)
                                call dumpsp
                                next 1
                            } else {
#
#     call the line printer plot routine
#
                                if (i==ihp) {
                                    call wavlng (itrol(1), itrol(2), ier)
                                    j = 1
                                    if (x>10) x = 10
                                    if (x>0) j = x
                                    do ij = 1,j
                                    call lprpct(1,nchans,lbnd,ubnd,dataa)
                                }
                                if (i==ihx) go to 30
                                next 1
                            }
                        }
                    }
910                 continue
                    if (il != 0) j = j-1
                    if (x>0 && x<maxrec) ji = j
                    call wavlng (itrol(1), itrol(2), ier)
                }
920             continue
                write(outline,80)
                call gwrite(outline)

                call crtin
                ii = 1
                call wjfren(ii,x,irv)
                if (irv!=ihc) go to 950
930             continue
            }
        }
940     continue
    }
}
950   continue
if (irv==ihe) call er
if (irv==ihx) ictrl = ihx
return

30  ixit = ihx
    return

# RED Added SOLARIS and SUNOS below

40  format(4x,a,2x,'file= ',a,i5,' (',a,')')
41  format(4x,'history=',a)
#NONHPUX%42        format(' wav: ',a1,i5,'  ch=',i5,5x,
#NONHPUX%     C 'h=channel, a=wave, n=energy',$)
#SOLARIS%42        format(' wav: ',a1,i5,'  ch=',i5,5x,
#SOLARIS%     C 'h=channel, a=wave, n=energy',$)
#SUNOS%42        format(' wav: ',a1,i5,'  ch=',i5,5x,
#SUNOS%     C 'h=channel, a=wave, n=energy',$)
#DEC%42        format(' wav: ',a1,i5,'  ch=',i5,5x,
#DEC%     C 'h=channel, a=wave, n=energy',$)
#HPUX%42        format(' wav: ',a1,i5,'  ch=',i5,5x,
#HPUX%     C 'h=channel, a=wave, n=energy',$)
#LINUX%42        format(' wav: ',a1,i5,'  ch=',i5,5x,
#LINUX%     C 'h=channel, a=wave, n=energy',$)
#IA64HPUX%42        format(' wav: ',a1,i5,'  ch=',i5,5x,
#IA64HPUX%     'h=channel, a=wave, n=energy',$)

43  format(' wav: ',a1,i5,'  ch=',i5,5x,'h=channel,  a=wavelength,  n=energy')
45  format(1x,'Wavelength specification out of range: ',a,i5)
60  format(' type: c=Change SCALE;')
61  format(5x,'e=EXIT routine;  g=Remove GLITCHES  l+number=LINE TYPE')
62  format(5x,'r+channels+c=DELETE Channels;   A=Interactive BAND ANALYSIS')
63  format(5x,'p=LPrinter PLOT; i=Change other INFO;   G=read Graphics CURSOR pos.')
64  format(4x,' pd=PRINT data;   x=EXIT routine WITHOUT WRITING data record')
72  format(26(' '),'Graphics Cursor Read Routine')
73  format(12(' '),'to enter Graphics Cursor Pos: <cr> or e to exit')
74  format(5x,'Use left mouse button to pick position or right mouse button to exit')
80  format(1x,'type  c  to Change SCALE, e to ERASE, x to EXIT, or return to continue')
end
